name: CD-FiapCloudGamesAPI

trigger: none  # Não dispara sozinho em commits

resources:
  pipelines:
  - pipeline: CI
    source: CI-azure-pipelines  # Nome do pipeline CI no DevOps
    trigger:
      branches:
        include:
          - main  # Só dispara CD quando o CI passar na branch main

variables:
  dockerImage: gabrielpaulino/fiapcloudgamesapi:latest

stages:
- stage: Deploy
  displayName: 'Deploy da imagem Docker no Azure App Service'
  jobs:
  - deployment: DeployToAzure
    environment: 'production' 
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self

          - task: UseDotNet@2
            displayName: 'Instalar .NET 8 SDK'
            inputs:
              packageType: sdk
              version: '8.0.x'

          # Restore com caminho absoluto e nuget.config limpo
          - script: dotnet restore "$(Build.SourcesDirectory)/FiapCloudGamesAPI/FiapCloudGamesAPI.csproj" --configfile "$(Build.SourcesDirectory)/nuget.config"
            displayName: 'Restore com NuGet oficial (sem feed privado)'

          # Instala dotnet-ef em um diretório local (.tools)
          - script: dotnet tool install dotnet-ef --tool-path .tools --configfile "$(Build.SourcesDirectory)/nuget.config"
            displayName: 'Instalar dotnet-ef local'

          # Aplica migrations usando o dotnet-ef local
          - script: ./.tools/dotnet-ef database update --project FiapCloudGamesAPI/FiapCloudGamesAPI.csproj
            displayName: 'Aplicar Migrations'
            env:
              ConnectionStrings__Default: $(sql_string_connection)

          # Deploy da imagem Docker no App Service
          - task: AzureWebAppContainer@1
            displayName: 'Deploy Docker Image'
            inputs:
              azureSubscription: 'fiap-azure-connection'
              appName: 'fiap-cloudgames-api'
              imageName: $(dockerImage)
